import subprocess
import re

def get_interfaces_status():
    """Mendapatkan status interface jaringan menggunakan perintah ip link show."""
    try:
        result = subprocess.run(['ip', 'link', 'show'], capture_output=True, text=True, check=True)
        output = result.stdout
        interfaces = {}
        
        # Parse output untuk menemukan interface dan statusnya
        lines = output.strip().split('\n')
        for line in lines:
            match = re.match(r'^\d+:\s+(\w+):\s+<([^>]+)>.*state\s+(\w+)', line)
            if match:
                iface = match.group(1)
                flags = match.group(2)
                state = match.group(3)
                interfaces[iface] = state
        return interfaces
    except subprocess.CalledProcessError as e:
        print(f"Error running ip link show: {e}")
        return {}

def disable_down_interfaces(interfaces):
    """Mendisable interface yang statusnya DOWN, kecuali loopback (lo)."""
    disabled = []
    for iface, state in interfaces.items():
        if iface != 'lo' and state == 'DOWN':
            try:
                subprocess.run(['sudo', 'ip', 'link', 'set', 'dev', iface, 'down'], check=True)
                disabled.append(iface)
                print(f"Disabled interface: {iface}")
            except subprocess.CalledProcessError as e:
                print(f"Failed to disable {iface}: {e}")
    return disabled

def main():
    print("Checking network interfaces...")
    interfaces = get_interfaces_status()
    
    if not interfaces:
        print("Unable to retrieve interface status.")
        return
    
    down_interfaces = [iface for iface, state in interfaces.items() if state == 'DOWN' and iface != 'lo']
    
    if down_interfaces:
        print(f"Found down interfaces: {', '.join(down_interfaces)}")
        disabled = disable_down_interfaces(interfaces)
        if disabled:
            print(f"Successfully disabled: {', '.join(disabled)}")
        else:
            print("No interfaces were disabled.")
    else:
        print("All interfaces are up. No action needed.")

if __name__ == "__main__":
    main()
